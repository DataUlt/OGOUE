<!DOCTYPE html>
<html class="light" lang="fr">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Historique des Suppressions - OGOUE</title>

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com" rel="preconnect"/>
    <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin/>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;700;800&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>

    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#0088CC",
                        "secondary": "#1E3A5F",
                        "background-light": "#f6f8f6",
                        "background-dark": "#111712",
                        "card-light": "#FFFFFF",
                        "card-dark": "#1a2622",
                        "text-light-primary": "#0a0c0a",
                        "text-dark-primary": "#E2E8F0",
                        "text-light-secondary": "#5c6c60",
                        "text-dark-secondary": "#94A3B8",
                        "border-light": "#e8ede8",
                        "border-dark": "#334155",
                        "success": "#27AE60",
                        "danger": "#E74C3C",
                    },
                    fontFamily: { "display": ["Manrope", "sans-serif"] },
                    borderRadius: {
                        "DEFAULT": "1rem",
                        "lg": "2rem",
                        "xl": "3rem",
                        "full": "9999px"
                    },
                },
            },
        }
    </script>

    <style>
        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 300, 'GRAD' 0, 'opsz' 24;
        }
    </style>
</head>

<body class="font-display bg-background-light dark:bg-background-dark text-text-light-primary dark:text-text-dark-primary">
<div class="relative flex min-h-screen w-full flex-col group/design-root overflow-x-hidden">

    <!-- HEADER -->
    <header class="sticky top-0 z-10 w-full bg-background-light/80 dark:bg-background-dark/80 backdrop-blur-sm border-b border-[#e8ede8] dark:border-gray-700">
        <div class="container mx-auto px-4">
            <div class="flex items-center justify-between whitespace-nowrap h-20">
                <div class="flex items-center gap-4">
                    <a href="module_tableau_bord.html"><img src="/app/Logo-ogoue (2).png" alt="OGOUÉ Logo" class="h-28 w-auto"></a>
                </div>
                <button class="flex h-10 w-10 cursor-pointer items-center justify-center rounded-full bg-primary/20 text-[#0a0c0a] dark:bg-primary/30 dark:text-white"
                     onclick="window.history.back()">
                    <span class="material-symbols-outlined">arrow_back</span>
                </button>
            </div>
        </div>
    </header>

    <!-- MAIN CONTENT -->
    <main class="flex-grow">
        <div class="container mx-auto px-4 py-8">
            <div class="layout-content-container flex flex-col w-full max-w-7xl mx-auto flex-1 gap-6">

                <!-- TITRE ET STATS -->
                <div>
                    <h1 class="text-3xl font-bold mb-2">Historique des Suppressions</h1>
                    <p class="text-text-light-secondary dark:text-text-dark-secondary">
                        Consultez tous les enregistrements supprimés avec les motifs et informations de suppression
                    </p>
                </div>

                <!-- STATISTIQUES -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="rounded-xl border border-border-light dark:border-border-dark p-6 bg-card-light dark:bg-card-dark shadow-sm">
                        <p class="text-text-light-secondary dark:text-text-dark-secondary text-sm font-medium mb-1">
                            Total Suppressions
                        </p>
                        <p class="text-3xl font-bold text-primary" id="total-deletions">0</p>
                    </div>
                    <div class="rounded-xl border border-border-light dark:border-border-dark p-6 bg-card-light dark:bg-card-dark shadow-sm">
                        <p class="text-text-light-secondary dark:text-text-dark-secondary text-sm font-medium mb-1">
                            Dépenses Supprimées
                        </p>
                        <p class="text-3xl font-bold text-danger" id="expenses-deleted">0</p>
                    </div>
                    <div class="rounded-xl border border-border-light dark:border-border-dark p-6 bg-card-light dark:bg-card-dark shadow-sm">
                        <p class="text-text-light-secondary dark:text-text-dark-secondary text-sm font-medium mb-1">
                            Ventes Supprimées
                        </p>
                        <p class="text-3xl font-bold text-warning" id="sales-deleted">0</p>
                    </div>
                </div>

                <!-- FILTRES -->
                <div class="flex gap-4 flex-wrap">
                    <select id="type-filter" class="px-6 py-2 rounded-lg border border-border-light dark:border-border-dark bg-card-light dark:bg-card-dark text-text-light-primary dark:text-text-dark-primary min-w-[180px]">
                        <option value="">Tous les types</option>
                        <option value="expense">Dépenses</option>
                        <option value="sale">Ventes</option>
                    </select>

                    <select id="month-filter" class="px-6 py-2 rounded-lg border border-border-light dark:border-border-dark bg-card-light dark:bg-card-dark text-text-light-primary dark:text-text-dark-primary min-w-[180px]">
                        <option value="">Tous les mois</option>
                        <option value="1">Janvier</option>
                        <option value="2">Février</option>
                        <option value="3">Mars</option>
                        <option value="4">Avril</option>
                        <option value="5">Mai</option>
                        <option value="6">Juin</option>
                        <option value="7">Juillet</option>
                        <option value="8">Août</option>
                        <option value="9">Septembre</option>
                        <option value="10">Octobre</option>
                        <option value="11">Novembre</option>
                        <option value="12">Décembre</option>
                    </select>

                    <select id="year-filter" class="px-6 py-2 rounded-lg border border-border-light dark:border-border-dark bg-card-light dark:bg-card-dark text-text-light-primary dark:text-text-dark-primary min-w-[180px]">
                        <option value="">Toutes les années</option>
                        <option value="2024">2024</option>
                        <option value="2025">2025</option>
                        <option value="2026">2026</option>
                    </select>

                    <button id="filter-btn" class="px-4 py-2 rounded-lg bg-primary text-white hover:bg-primary/90 transition-colors">
                        Appliquer les filtres
                    </button>
                </div>

                <!-- TABLEAU DES SUPPRESSIONS -->
                <div class="rounded-xl border border-border-light dark:border-border-dark bg-card-light dark:bg-card-dark shadow-sm overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead>
                                <tr class="border-b border-border-light dark:border-border-dark bg-background-light dark:bg-background-dark">
                                    <th class="px-6 py-3 text-left font-semibold text-text-light-primary dark:text-text-dark-primary">
                                        Type
                                    </th>
                                    <th class="px-6 py-3 text-left font-semibold text-text-light-primary dark:text-text-dark-primary">
                                        Date
                                    </th>
                                    <th class="px-6 py-3 text-left font-semibold text-text-light-primary dark:text-text-dark-primary">
                                        Supprimé par
                                    </th>
                                    <th class="px-6 py-3 text-left font-semibold text-text-light-primary dark:text-text-dark-primary">
                                        Motif
                                    </th>
                                    <th class="px-6 py-3 text-center font-semibold text-text-light-primary dark:text-text-dark-primary">
                                        Actions
                                    </th>
                                </tr>
                            </thead>
                            <tbody id="deletions-tbody">
                                <tr>
                                    <td colspan="5" class="px-6 py-8 text-center text-text-light-secondary dark:text-text-dark-secondary">
                                        <span class="material-symbols-outlined inline-block mr-2">hourglass_empty</span>
                                        Chargement...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

            </div>
        </div>
    </main>

</div>

<script>
    // Déterminer l'URL du backend
    const API_BASE_URL = (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1')
      ? 'http://localhost:3001'
      : 'https://api.ogoue.com';

    // Initialiser les variables globales
    let currentDeletions = [];

    // Récupérer les données d'audit
    async function loadDeletionHistory(filters = {}) {
        try {
            const params = new URLSearchParams();
            if (filters.recordType) params.append("recordType", filters.recordType);
            if (filters.month) params.append("month", filters.month);
            if (filters.year) params.append("year", filters.year);

            const response = await fetch(`${API_BASE_URL}/api/audit/deletions?${params}`, {
                headers: {
                    "Authorization": `Bearer ${localStorage.getItem("authToken")}`
                }
            });

            if (!response.ok) {
                throw new Error("Erreur lors du chargement des données");
            }

            const data = await response.json();
            return data.history || [];
        } catch (error) {
            console.error("❌ Erreur:", error);
            alert("Erreur lors du chargement de l'historique");
            return [];
        }
    }

    // Charger les statistiques
    async function loadStats() {
        try {
            const response = await fetch(`${API_BASE_URL}/api/audit/stats`, {
                headers: {
                    "Authorization": `Bearer ${localStorage.getItem("authToken")}`
                }
            });

            if (!response.ok) throw new Error("Erreur stats");

            const data = await response.json();
            document.getElementById("total-deletions").textContent = data.totalDeletions;
            document.getElementById("expenses-deleted").textContent = data.byType?.expense || 0;
            document.getElementById("sales-deleted").textContent = data.byType?.sale || 0;
        } catch (error) {
            console.error("❌ Erreur stats:", error);
        }
    }

    // Afficher les suppressions dans le tableau
    function renderDeletions(deletions = []) {
        deletions = deletions || [];
        currentDeletions = deletions; // Store for later reference in delete function
        const tbody = document.getElementById("deletions-tbody");

        if (!deletions || deletions.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="5" class="px-6 py-8 text-center text-text-light-secondary dark:text-text-dark-secondary">
                        <span class="material-symbols-outlined inline-block mr-2">search_off</span>
                        Aucun enregistrement trouvé
                    </td>
                </tr>
            `;
            return;
        }

        tbody.innerHTML = deletions.map(deletion => `
            <tr class="border-b border-border-light dark:border-border-dark hover:bg-background-light dark:hover:bg-background-dark transition-colors">
                <td class="px-6 py-4">
                    <span class="inline-block px-2 py-1 rounded-lg text-xs font-semibold
                        ${deletion.type === 'expense' ? 'bg-danger/20 text-danger' : 'bg-success/20 text-success'}">
                        ${deletion.type === 'expense' ? 'Dépense' : 'Vente'}
                    </span>
                </td>
                <td class="px-6 py-4 text-text-light-secondary dark:text-text-dark-secondary">
                    ${(() => {
                        const date = new Date(deletion.date);
                        // Ajouter 1 heure pour le fuseau horaire du Gabon (UTC+1)
                        date.setHours(date.getHours() + 1);
                        return date.toLocaleString('fr-FR', { 
                            year: 'numeric', 
                            month: 'short', 
                            day: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit',
                            hour12: false
                        });
                    })()}
                </td>
                <td class="px-6 py-4">
                    ${deletion.supprimePar ? `
                        <div class="font-medium">${deletion.supprimePar.nom}</div>
                    ` : 'Utilisateur supprimé'}
                </td>
                <td class="px-6 py-4 text-text-light-secondary dark:text-text-dark-secondary max-w-xs truncate">
                    ${deletion.motif}
                </td>
                <td class="px-6 py-4 text-center flex gap-2 justify-center">
                    <button class="inline-block px-3 py-1 rounded-lg bg-primary/20 text-primary hover:bg-primary/30 transition-colors"
                         onclick="showDeletionDetail('${deletion.id}')">
                        <span class="material-symbols-outlined text-lg">visibility</span>
                    </button>
                    <button class="inline-block px-3 py-1 rounded-lg bg-danger/20 text-danger hover:bg-danger/30 transition-colors"
                         onclick="deleteDeletionRecord('${deletion.id}')">
                        <span class="material-symbols-outlined text-lg">delete</span>
                    </button>
                </td>
            </tr>
        `).join('');
    }

    // Afficher les détails d'une suppression
    async function showDeletionDetail(deletionId) {
        try {
            const response = await fetch(`${API_BASE_URL}/api/audit/deletions/${deletionId}`, {
                headers: {
                    "Authorization": `Bearer ${localStorage.getItem("authToken")}`
                }
            });

            if (!response.ok) throw new Error("Erreur");

            const deletion = await response.json();

            const modal = document.createElement("div");
            modal.className = "fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4";
            modal.innerHTML = `
                <div class="bg-card-light dark:bg-card-dark rounded-lg shadow-xl max-w-2xl w-full p-6 max-h-[90vh] overflow-y-auto">
                    <h2 class="text-2xl font-bold mb-4">Détails de la Suppression</h2>

                    <div class="space-y-4 mb-6">
                        <div>
                            <p class="text-sm font-semibold text-text-light-secondary dark:text-text-dark-secondary">Type</p>
                            <p class="text-lg">${deletion.type}</p>
                        </div>

                        <div>
                            <p class="text-sm font-semibold text-text-light-secondary dark:text-text-dark-secondary">Date</p>
                            <p class="text-lg">${(() => {
                                const date = new Date(deletion.date);
                                // Ajouter 1 heure pour le fuseau horaire du Gabon (UTC+1)
                                date.setHours(date.getHours() + 1);
                                return date.toLocaleString('fr-FR', { 
                                    year: 'numeric', 
                                    month: 'long', 
                                    day: 'numeric',
                                    hour: '2-digit',
                                    minute: '2-digit',
                                    second: '2-digit',
                                    hour12: false
                                });
                            })()}</p>
                        </div>

                        <div>
                            <p class="text-sm font-semibold text-text-light-secondary dark:text-text-dark-secondary">Supprimé par</p>
                            <p class="text-lg font-medium">${deletion.supprimePar?.nom || 'Inconnu'}</p>
                            <p class="text-sm text-text-light-secondary dark:text-text-dark-secondary">${deletion.supprimePar?.email || ''}</p>
                        </div>

                        <div>
                            <p class="text-sm font-semibold text-text-light-secondary dark:text-text-dark-secondary mb-2">Motif</p>
                            <div class="p-3 rounded-lg bg-background-light dark:bg-background-dark border border-border-light dark:border-border-dark">
                                <p class="whitespace-pre-wrap">${deletion.motif}</p>
                            </div>
                        </div>

                        <div>
                            <p class="text-sm font-semibold text-text-light-secondary dark:text-text-dark-secondary mb-2">Données supprimées</p>
                            <div class="p-3 rounded-lg bg-background-light dark:bg-background-dark border border-border-light dark:border-border-dark">
                                ${(() => {
                                    // Champs à exclure
                                    const fieldsToExclude = ['id', 'created_at', 'updated_at', 'receipt_url', 'organization_id', 'receipt_storage_path'];
                                    
                                    // Traduction des champs
                                    const fieldNames = {
                                        'amount': 'Montant',
                                        'quantity': 'Quantité',
                                        'sale_date': 'Date de vente',
                                        'sale_type': 'Type de vente',
                                        'description': 'Description',
                                        'receipt_name': 'Nom du reçu',
                                        'payment_method': 'Méthode de paiement',
                                        'date': 'Date',
                                        'category': 'Catégorie',
                                        'beneficiary': 'Bénéficiaire',
                                        'notes': 'Notes'
                                    };
                                    
                                    // Filtrer et formater les données
                                    const filteredData = Object.entries(deletion.donnees)
                                        .filter(([key]) => !fieldsToExclude.includes(key))
                                        .map(([key, value]) => {
                                            const displayKey = fieldNames[key] || key;
                                            let displayValue = value;
                                            
                                            // Formater les URLs
                                            if (typeof value === 'string' && value.startsWith('http')) {
                                                displayValue = `<a href="${value}" target="_blank" class="text-primary hover:underline">Voir le fichier</a>`;
                                            }
                                            // Formater les dates
                                            else if (key.includes('date') && value) {
                                                displayValue = new Date(value).toLocaleDateString('fr-FR');
                                            }
                                            // Formater les montants
                                            else if (key.includes('amount') && typeof value === 'number') {
                                                displayValue = value.toLocaleString('fr-FR', { style: 'currency', currency: 'XAF' });
                                            }
                                            
                                            return { key: displayKey, value: displayValue };
                                        });
                                    
                                    return `
                                        <div class="space-y-2">
                                            ${filteredData.map(({ key, value }) => `
                                                <div class="flex justify-between items-start border-b border-border-light dark:border-border-dark pb-2">
                                                    <span class="font-medium text-text-light-secondary dark:text-text-dark-secondary">${key}:</span>
                                                    <span class="text-right max-w-xs">${value}</span>
                                                </div>
                                            `).join('')}
                                        </div>
                                    `;
                                })()}
                            </div>
                        </div>
                    </div>

                    <div class="flex justify-end">
                        <button onclick="this.closest('.fixed').remove()" 
                             class="px-4 py-2 rounded-lg bg-primary text-white hover:bg-primary/90 transition-colors">
                            Fermer
                        </button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
            modal.addEventListener("click", (e) => {
                if (e.target === modal) modal.remove();
            });
        } catch (error) {
            console.error("❌ Erreur:", error);
            alert("Erreur lors du chargement des détails");
        }
    }

    async function deleteDeletionRecord(deletionId) {
        const deletion = currentDeletions.find(d => d.id === deletionId);
        if (!deletion) return;

        // Confirmation dialog
        const confirmed = confirm(
            `Êtes-vous sûr de vouloir supprimer cet enregistrement d'audit?\n\nType: ${deletion.type}\nDate: ${new Date(deletion.date).toLocaleDateString('fr-FR')}\nMotif: ${deletion.raison}`
        );

        if (!confirmed) return;

        try {
            const token = localStorage.getItem('authToken');
            const response = await fetch(`${API_BASE_URL}/api/audit/deletions/${deletionId}`, {
                method: 'DELETE',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.message || 'Erreur lors de la suppression');
            }

            // Remove from current list and refresh
            currentDeletions = currentDeletions.filter(d => d.id !== deletionId);
            renderDeletions();
            
            // Show success
            const successDiv = document.createElement('div');
            successDiv.className = 'fixed top-4 right-4 bg-cyan-50 dark:bg-cyan-900 border border-cyan-200 dark:border-cyan-700 text-cyan-800 dark:text-cyan-100 px-4 py-3 rounded-lg';
            successDiv.textContent = 'Enregistrement d\'audit supprimé avec succès';
            document.body.appendChild(successDiv);
            
            setTimeout(() => successDiv.remove(), 3000);
        } catch (error) {
            console.error('❌ Erreur lors de la suppression:', error);
            alert(`Erreur: ${error.message}`);
        }
    }

    // Événements des filtres
    document.getElementById("filter-btn").addEventListener("click", async () => {
        try {
            const filters = {
                recordType: document.getElementById("type-filter").value || "",
                month: document.getElementById("month-filter").value ? parseInt(document.getElementById("month-filter").value) : undefined,
                year: document.getElementById("year-filter").value ? parseInt(document.getElementById("year-filter").value) : undefined,
            };

            console.log("Filtres appliqués:", filters);
            
            const deletions = await loadDeletionHistory(filters);
            console.log("Résultats après filtrage:", deletions);
            
            currentDeletions = deletions;
            renderDeletions(deletions);
            
            // Recharger aussi les statistiques
            await loadStats();
        } catch (error) {
            console.error("Erreur lors de l'application des filtres:", error);
            alert("Erreur lors de l'application des filtres");
        }
    });

    // Charger au démarrage
    (async () => {
        await loadStats();
        const deletions = await loadDeletionHistory();
        renderDeletions(deletions);
    })();
</script>

</body>
</html>
